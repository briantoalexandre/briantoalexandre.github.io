from customtkinter import *
from tkinter import messagebox
from requests import get
from os import listdir as ls, mkdir, path
from time import sleep as sl

class App(CTk):
    def __init__(self):
        super().__init__()
        self.title("downloader")
        self.geometry("400x300")
        self.titlefont = CTkFont(size=28)
        self.font = CTkFont(size=18)

        self.filename = "links.txt"
        self.dirname = "App_folder/"

        self.label_title = CTkLabel(self, text="Downloader", font=self.titlefont)
        self.button_download = CTkButton(self, text="DOWNLOAD", command=self.Download)
        self.button_checkFile = CTkButton(self, text="Check file", command=self.CheckFileContent)
        self.Frame_options = CTkFrame(self, fg_color=self.cget("fg_color"))

        self.label_title.pack(side=TOP, pady=5)
        self.button_download.pack(side=TOP)
        self.button_checkFile.pack(side=TOP)
        self.Frame_options.pack(side=TOP, fill=BOTH, expand=True)

        self.ERROR = messagebox.showerror
        self.CHOICE = messagebox.askokcancel

        self.InfoWindow__init__()

        self.protocol("WM_DELETE_WINDOW", func=self.Close)


    def InfoWindow__init__(self):
        self.Infowindow = SubWindow()
        self.Hide_InfoWindow()

    def Show_InfoWindow(self):
        self.Infowindow.deiconify()

    def Hide_InfoWindow(self):
        self.Infowindow.withdraw()

    def CheckFileContent(self):
        file_data = self.Get_links()
        self.Infowindow.Insert(file_data)
        self.Show_InfoWindow()

    def Close(self):
        self.Infowindow.CloseSub()
        self.quit()
        quit()

    def MakeFile(self, filename : tuple, data : str):
        with open(self.dirname+"".join(filename), "x", encoding="utf-8") as xf:
            xf.write(data)

    def Steal_Data(self, url : str) -> str: #shhh
        return get(url, allow_redirects=True).text


    def Get_links(self) -> str | None:
        filename = self.filename
        if path.exists(filename):
            with open(filename, "r", encoding="utf-8") as  rf:
                data =  rf.read()
            if len(data) != 0:
                return data
            else:
                self.ERROR(title="Empty File Error", message=f"\"{filename}\" is empty!")
                self.Close()
        else:
            self.ERROR(title="1File not found Error", message=f"\"{filename}\" not found")
            self.Close()

    def Get_directory(self) -> bool:
        dirname = self.dirname
        if path.exists(dirname):
            if len(ls(dirname)) != 0:
                return False
            else:
                return True
        else:
            mkdir(dirname)
            return True

    def Download(self):
        if self.Get_directory():
            links = self.Get_links().splitlines()
            for url in links:
                filename = path.splitext(path.split(url)[1]) #with extensions
                filecontent = self.Steal_Data(url)
                self.MakeFile(filename, filecontent)

        else:
            self.ERROR(title="Directory not empty Error", message=f"place remove the files inside the folder \"{self.dirname}\"")

class SubWindow(CTkToplevel):
    def __init__(self):
        super().__init__()
        self.title("")
        self.geometry("500x600")
        self.font = CTkFont(family="Consolas", size=18)

        self.Frame_info = CTkFrame(self, fg_color=self.cget("fg_color"))
        self.Textbox_info = CTkTextbox(self.Frame_info, font=self.font, fg_color=self.cget("fg_color"))

        self.Textbox_info.pack(fill=BOTH, expand=True)

        self.protocol("WM_DELETE_WINDOW", func=self.Close)

    def DisplayUnload(self):
        self.Frame_info.forget()

    def Insert(self, data : str):
        self.DisplayUnload()
        self.Frame_info.pack(fill=BOTH, expand=True)
        self.title("File Data - \"links.txt\"")
        self.Textbox_info.delete(END)
        self.Textbox_info.insert(index=END, text=data)
        

    def Close(self):
        self.withdraw()

    def CloseSub(self):
        self.quit()

Main = App()

Main.mainloop()